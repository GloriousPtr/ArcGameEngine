name: Build
on:
  push:
    paths-ignore:
      - '.github/resources/**'
      - '**.md'
      - '**.txt'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '.github/resources/**'
      - '**.md'
      - '**.txt'
  schedule:
    - cron: '23 17 * * 3'
jobs:
  build:
    name: Build for ${{matrix.BUILD_CONFIGURATION}}-${{matrix.COMPILER}}
    runs-on: windows-latest
    strategy:
      matrix:
        BUILD_CONFIGURATION:
          - Debug
          - Release
          - Dist
        COMPILER:
          - msvc
          - clang
          - llvm
    env:
      SOLUTION_FILE_PATH: "Arc.sln"
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
          submodules: true

      - name: Set up MSBuild
        uses: microsoft/setup-msbuild@v1.1

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: "pip3 install requests"
      
      - name: Generate Project Files
        run: |
          cd scripts
          python Setup.py ${{matrix.COMPILER}}
          cd ..
      
      - name: Run Build
        run: |
          msbuild /m /p:Configuration=${{matrix.BUILD_CONFIGURATION}} ${{env.SOLUTION_FILE_PATH}} /t:rebuild /nodeReuse:false
      
      - uses: actions/upload-artifact@v3
        with:
          name: "Arc_${{matrix.COMPILER}}_${{matrix.BUILD_CONFIGURATION}}"
          path: "${{ github.workspace }}/bin/${{matrix.BUILD_CONFIGURATION}}-windows-x86_64"
